---
# OpenShift Workload Destroyer - Optimized for destroy operations
# This role provides fast, resilient cleanup of workloads across multiple clusters
# Unlike openshift_workload_deployer, this role skips unnecessary cluster discovery
# and continues operation even when some clusters are unreachable

- name: Debug workloads and clusters for destroy operation
  ansible.builtin.debug:
    msg: |
      openshift_workload_destroyer_clusters: {{ openshift_workload_destroyer_clusters }}
      openshift_workload_destroyer_workloads: {{ openshift_workload_destroyer_workloads }}
    verbosity: 2

- name: Initialize destroy operation tracking
  ansible.builtin.set_fact:
    _reachable_clusters: {}
    _unreachable_clusters: []
    _successful_destroys: []
    _failed_destroys: []

- name: Set cluster configs from openshift_workload_destroyer_clusters dictionary
  when: openshift_workload_destroyer_clusters is mapping
  ansible.builtin.set_fact:
    _cluster_configs: "{{ openshift_workload_destroyer_clusters }}"

- name: Convert deprecated list format for openshift_workload_destroyer_clusters
  ansible.builtin.set_fact:
    _cluster_configs: "{{ _cluster_configs | default({}) | combine({item.key: item.value}) }}"
  loop: >-
    {{ [] if openshift_workload_destroyer_clusters is mapping else
       (openshift_workload_destroyer_clusters | map('dict2items') | list | flatten)
    }}
  loop_control:
    label: "{{ item.key }}"

- name: Test cluster connectivity on referenced clusters (non-blocking)
  ansible.builtin.include_tasks: test_cluster_connectivity.yml
  loop: >-
    {{ openshift_workload_destroyer_workloads
     | json_query("[?@.no_k8s_api != `true`].clusters|[]")
     | unique
    }}
  loop_control:
    loop_var: current_cluster_name
    label: "Testing connectivity to: {{ current_cluster_name }}"
  vars:
    current_cluster_config: "{{ _cluster_configs[current_cluster_name] }}"

- name: Display connectivity summary
  ansible.builtin.debug:
    msg:
      - "Cluster connectivity summary:"
      - "Reachable clusters: {{ _reachable_clusters | dict2items | selectattr('value', 'equalto', true) | map(attribute='key') | list }}"
      - "Unreachable clusters: {{ _unreachable_clusters }}"

- name: Execute destroy workloads on reachable clusters
  ansible.builtin.include_tasks: destroy_workload_on_cluster.yml
  loop: "{{ openshift_workload_destroyer_workloads }}"
  loop_control:
    loop_var: workload_item
    label: "Destroying workload: {{ workload_item.name }}"

- name: Display destroy operation summary
  ansible.builtin.debug:
    msg:
      - "=== DESTROY OPERATION SUMMARY ==="
      - "Successful destroys: {{ _successful_destroys }}"
      - "Failed destroys: {{ _failed_destroys }}"
      - "Unreachable clusters (skipped): {{ _unreachable_clusters }}"
      - "Operation completed - check logs above for details"
