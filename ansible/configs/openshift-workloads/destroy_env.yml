---
- name: Destroy workload(s)
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  tasks:
  - name: Check that remove_workloads is a list
    when: remove_workloads is not defined or remove_workloads is not sequence
    ansible.builtin.fail:
      msg: "remove_workloads variable is either not defined or is not a list"

  - name: Set workloads to remove in standard format
    loop: "{{ remove_workloads }}"
    loop_control:
      label: "{{ _workload.name }} on {{ _clusters | join(',') }}"
    vars:
      _workload: "{{ item if item is mapping else {'name': item} }}"
      _clusters: "{{ _workload.clusters | default(['default']) }}"
    ansible.builtin.set_fact:
      _workloads: >-
        {{ _workloads | default([]) + [_workload | combine({"clusters": _clusters})] }}

  - name: Destroy remove_workloads on cluster(s) using optimized destroyer role
    when: remove_workloads | length > 0
    ansible.builtin.include_role:
      name: openshift_workload_destroyer
    vars:
      ACTION: destroy
      openshift_workload_destroyer_workloads: "{{ _workloads }}"
      openshift_workload_destroyer_clusters: "{{ clusters }}"
